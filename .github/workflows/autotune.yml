name: auto-tune-weekly
on:
  schedule:
    # 매주 토요일 UTC 10:00 (KST 일요일 19:00)
    # 백테스트(UTC 12:00) 전에 실행하여, 튜닝 → 백테스트 순서로 진행
    - cron: "0 10 * * 6"

  workflow_dispatch:
    inputs:
      days:
        description: "백테스트 기간 (거래일)"
        default: "60"
        type: string
      dry_run:
        description: "미리보기만 (저장 안 함)"
        default: false
        type: boolean
      rollback:
        description: "직전 설정으로 롤백"
        default: false
        type: boolean

jobs:
  autotune:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - run: python -m pip install -U pip
      - run: python -m pip install -r requirements.txt

      - name: NLTK data
        run: python -c "import nltk; nltk.download('vader_lexicon', quiet=True)"

      - name: Rollback
        if: ${{ inputs.rollback }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: python run_autotune.py --rollback --discord

      - name: Auto-Tune
        if: ${{ !inputs.rollback }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          FLAGS="--days ${{ inputs.days || '60' }} --discord"
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            FLAGS="$FLAGS --dry-run"
          fi
          python run_autotune.py $FLAGS

      - name: Commit changes
        if: ${{ !inputs.dry_run }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add config/ data/

          if git diff --staged --quiet; then
            echo "No config changes"
          else
            git commit -m "chore(autotune): strategy update $(date -u +'%Y-%m-%d')"
            git push
          fi
