name: backtest-weekly
on:
  schedule:
    # 매주 토요일 UTC 12:00 (KST 일요일 21:00)
    - cron: "0 12 * * 6"

  workflow_dispatch:
    inputs:
      days:
        description: "백테스트 기간 (거래일)"
        default: "90"
        type: string
      top_n:
        description: "일별 선택 종목 수"
        default: "5"
        type: string
      optimize:
        description: "파라미터 최적화 실행"
        default: false
        type: boolean

jobs:
  backtest:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - run: python -m pip install -U pip
      - run: python -m pip install -r requirements.txt

      - name: NLTK data
        run: python -c "import nltk; nltk.download('vader_lexicon', quiet=True)"

      - name: Run Backtest
        if: ${{ !inputs.optimize }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python run_backtest.py \
            --days ${{ inputs.days || '90' }} \
            --top ${{ inputs.top_n || '5' }} \
            --export --discord

      - name: Run Optimization
        if: ${{ inputs.optimize }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python run_backtest.py \
            --days ${{ inputs.days || '90' }} \
            --optimize --quick \
            --export --discord

      - name: Commit backtest results
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/backtest/

          if git diff --staged --quiet; then
            echo "No backtest changes"
          else
            git commit -m "chore: backtest results $(date -u +'%Y-%m-%d')"
            git push
          fi
